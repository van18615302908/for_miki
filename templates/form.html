{% extends "base.html" %}

{% block content %}
{% set story_name = story['name'] if story else '' %}
{% set story_title = story['title'] if story else '' %}
{% set story_body = story['body'] if story else '' %}
{% set selected = selected_tags if selected_tags else [] %}
{% set new_tags_prefill = new_tag_input if new_tag_input else '' %}
<section class="form-wrapper">
  <h2>分享善意故事</h2>
  <p class="subtitle">发布后不可修改，请仔细检查；故事将由心理老师审核通过后展示。</p>
  <form method="post" action="{{ form_action }}" enctype="multipart/form-data">
    <label>
      昵称（需填写班级 + 姓名）：
      <input type="text" name="name" required placeholder="如：高一3班 张三"
             value="{{ story_name }}">
    </label>
    <label>
      标题：
      <input type="text" name="title" required placeholder="一句话概括你的善意"
             value="{{ story_title }}">
    </label>
    <label>
      故事内容：
      <textarea name="body" rows="8" required placeholder="写下真实发生的善意瞬间">{{ story_body }}</textarea>
    </label>
    <label>
      上传照片（可选，最多 1 张）：
      <input type="file" name="photo" accept=".png,.jpg,.jpeg,.gif,.webp">
      <span class="input-hint">系统会自动压缩到 512KB 以内，支持 png/jpg/jpeg/gif/webp</span>
    </label>
    <div class="tag-selector">
      <p class="tag-selector-label">选择已有标签：</p>
      <div class="tag-option-grid">
        {% if tags %}
          {% for tag in tags %}
            <label class="tag-option">
              <input type="checkbox" name="tags" value="{{ tag['id'] }}" {% if tag['id'] in selected %}checked{% endif %}>
              <span>{{ tag["name"] }}</span>
            </label>
          {% endfor %}
        {% else %}
          <p class="muted">目前还没有标签，先创建一个吧！</p>
        {% endif %}
      </div>
    </div>
    <label>
      创建新标签（空格或逗号分隔）：
      <input type="text" name="new_tags" placeholder="如：寝室 温暖 互助" value="{{ new_tags_prefill }}">
    </label>
    <div class="form-actions">
      <a class="btn secondary" href="{{ url_for('index') }}">返回</a>
      <button class="btn primary" type="submit">提交审核</button>
    </div>
  </form>
</section>
{% endblock %}
