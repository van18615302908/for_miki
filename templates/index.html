{% extends "base.html" %}

{% block content %}
<section class="hero">
  <div>
    <p class="eyebrow">Kindness Stories</p>
    <h2>æŠŠä½ çš„å–„æ„æ•…äº‹æŠ•é€’åˆ°è¿™é‡Œ</h2>
    <p>ä¸éœ€è¦ç™»å½•ï¼Œéšæ‰‹è®°å½•æš–å¿ƒç¬é—´ï¼Œè®©æ›´å¤šåŒå­¦è¢«ç‚¹äº®ã€‚</p>
  </div>
</section>

{% if tags %}
<section class="tag-filter">
  <div class="tag-chip-wrapper">
    <a class="tag-chip {{ 'active' if not active_tag }}" href="{{ url_for('index', q=search_query, sort=sort_param) }}">å…¨éƒ¨</a>
    {% for tag in tags %}
      <a class="tag-chip {{ 'active' if active_tag == tag['id'] }}" href="{{ url_for('index', tag=tag['id'], q=search_query, sort=sort_param) }}">
        {{ tag["name"] }}
      </a>
    {% endfor %}
  </div>
</section>
{% endif %}

<div class="result-row">
  <p class="result-hint">
    {% if active_tag or search_query %}
      å…± {{ stories|length }} æ¡åŒ¹é…ç»“æœ
    {% else %}
      æœ€è¿‘çš„å–„æ„æ•…äº‹
    {% endif %}
  </p>
  <div class="sort-switch">
    <a class="sort-chip {{ 'active' if sort_param == 'likes' }}" href="{{ url_for('index', tag=active_tag, q=search_query, sort='likes') }}">æŒ‰ç‚¹èµ</a>
    <a class="sort-chip {{ 'active' if sort_param == 'latest' }}" href="{{ url_for('index', tag=active_tag, q=search_query, sort='latest') }}">æŒ‰æœ€æ–°</a>
  </div>
</div>

<section class="stories">
  {% if stories %}
    {% for story in stories %}
      <article class="story-card">
        <div class="story-header">
          <div>
            <h3>{{ story["title"] }}</h3>
            <p class="meta">æ¥è‡ª {{ story["name"] }} Â· æ›´æ–°äº {{ story["updated_at"].replace("T", " ") }}</p>
          </div>
          <div class="like-block">
            {% if story["likes"]|int >= 25 %}
              <img class="medal-badge" src="{{ url_for('static', filename='uploads/icons/medal.png') }}" alt="ç”µå­å¾½ç« " title="25+ æ¬¡ç‚¹èµ">
            {% endif %}
            {% set liked = story["id"] in liked_story_ids %}
            <form method="post" action="{{ url_for('like_story', story_id=story['id']) }}">
              <button type="submit" class="like-btn {{ 'active' if liked }}" title="{{ 'å–æ¶ˆç‚¹èµ' if liked else 'ç‚¹èµ' }}">
                {{ ' â¤ï¸å·²ç‚¹èµ' if liked else 'ğŸ¤ ç‚¹èµ' }} {{ story["likes"] }}
              </button>
            </form>
          </div>
        </div>
        {% if story["image_path"] %}
          <div class="story-image">
            <a href="{{ url_for('static', filename=story['image_path']) }}" target="_blank">
              <img src="{{ url_for('static', filename=story['image_path']) }}" alt="kindness photo">
            </a>
          </div>
        {% endif %}
        {% if story["tags"] %}
          <div class="tag-badges">
            {% for tag in story["tags"] %}
              <span class="tag-badge">{{ tag["name"] }}</span>
            {% endfor %}
          </div>
        {% endif %}
        {% set body_id = "story-body-" ~ story["id"] %}
        {% set is_long = story["body"]|length > 220 %}
        <div id="{{ body_id }}" class="story-body{% if is_long %} collapsible{% endif %}" {% if is_long %}data-collapsed="true"{% endif %}>
          {{ story["body"].replace("\n", "<br>")|safe }}
        </div>
        {% if is_long %}
          <button type="button" class="text-toggle" data-story-toggle="{{ body_id }}">å±•å¼€å…¨æ–‡</button>
        {% endif %}
      </article>
    {% endfor %}
  {% elif search_query or active_tag %}
    <div class="empty-state">
      <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•…äº‹ï¼Œæ¢ä¸ªå…³é”®è¯æˆ–æ ‡ç­¾è¯•è¯•ï¼Ÿ</p>
      <a class="btn secondary" href="{{ url_for('index') }}">æ¸…é™¤ç­›é€‰</a>
    </div>
  {% else %}
    <div class="empty-state">
      <p>æš‚æ— æ•…äº‹ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«å–„æ„çš„äººå§ï¼</p>
      <a class="btn secondary" href="{{ url_for('submit_story') }}">ç«‹å³åˆ†äº«</a>
    </div>
  {% endif %}
</section>
{% endblock %}
